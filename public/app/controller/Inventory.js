/*
 * File: app/controller/Inventory.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('coloMS.controller.Inventory', {
    extend: 'coloMS.controller.Base',

    views: [
        'inventory.List'
    ],
    stores: [
        'inventory.Vendors',
        'inventory.ProductTypes'
    ],
    refs: [
        {
            ref: 'InventoryList',
            selector: '[xtype=inventoryList]'
        }
    ],

    init: function() {
        this.listen({
            controller: {},
            component: {
                'grid[xtype=inventoryList]': {
                    edit: this.save,
                    canceledit: this.cancel,
                    beforerender: this.loadRecords,
                    itemcontextmenu: this.showContextMenu
                },
                'grid[xtype=inventoryList] button#add': {
                    click: this.add
                },
                'grid[xtype=inventoryList] gridview': {
                    itemadd: this.edit
                }
            },
            global: {},
            store: {}
        });
    },

    showContextMenu: function(view, record, item, index, e, eOpts) {
        var me = this;
        // stop event so browser's normal right-click action doesn't continue
        e.stopEvent();
        // if a menu doesn't already exist, create one
        if( !item.contextMenu ) {
            // add menu
            item.contextMenu = new Ext.menu.Menu({
                items: [
                {
                    text: 'Edit Item',
                    iconCls: 'icon_edit',
                    handler: function( item, e ) {
                        var grid = me.getInventoryList(),
                            plugin = grid.editingPlugin;
                        // start row edit
                        plugin.startEdit( record, 0 );
                    }
                },
                {
                    text: 'Delete Item',
                    iconCls: 'icon_delete',
                    handler: function( item, e ) {
                        me.remove( record );
                    }
                }
                ]
            })
        }
        // show menu relative to item which was right-clicked
        //item.contextMenu.showBy( item );
        item.contextMenu.showAt(e.getXY());
    },

    loadRecords: function(grid, eOpts) {
        var me = this,
            store = grid.getStore();
        // clear any fliters that have been applied
        store.clearFilter( true );
        // load the store
        store.load();
    },

    cancel: function(editor, context, eOpts) {
        // if the record is a phantom, remove from store and grid
        if( context.record.phantom ) {
            context.store.remove( context.record );
        }
    },

    edit: function(records, index, node, eOpts) {
        var me = this,
            grid = me.getInventoryList(),
            plugin = grid.editingPlugin;
        // start edit of row
        plugin.startEdit( records[ 0 ], 0 );
    },

    add: function(button, e, eOpts) {
        var me = this,
            grid = me.getInventoryList(),
            plugin = grid.editingPlugin,
            store = grid.getStore();
        // if we're already editing, don't allow new record insert
        if( plugin.editing ) {
            // show error message
            Ext.Msg.alert( 'Attention', 'Please finish editing before inserting a new record' );
            return false;
        }
        store.insert( 0, {} );
    },

    save: function(editor, context, eOpts) {
        var me = this,
            store = context.record.store;
        callbacks ={
            success: function( records, operation ) {
            },
            failure: function( records, operation ) {
                // if failure, reject changes in store
                store.rejectChanges();
            }
        };
        // save
        store.sync(callbacks);
    },

    remove: function(record) {
        var me = this,
            store = record.store;
        // show confirmation before continuing
        Ext.Msg.confirm( 'Attention', 'Are you sure you want to delete this item? This action cannot be undone.', function( buttonId, text, opt ) {
            if( buttonId=='yes' ) {
                store.remove( record );
                store.sync({
                    /**
                    * On failure, add record back to store at correct index
                    * @param {Ext.data.Model[]} records
                    * @param {Ext.data.Operation} operation
                    */
                    failure: function( records, operation ) {
                        store.rejectChanges();
                    }
                })
            }
        })
    }

});