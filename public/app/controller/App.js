/*
 * File: app/controller/App.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('coloMS.controller.App', {
    extend: 'coloMS.controller.Base',

    requires: [
        'coloMS.model.security.User',
        'coloMS.store.Audits'
    ],
    
    views: [
        'layout.West',
        'layout.Menu',
        'layout.North',
        'layout.South',
        'layout.Center',
        'layout.Landing',
        'Logs'
    ],
    
    store: [
      'Logs'
    ],
    
    refs: [
        {
            ref: 'Menu',
            selector: '[xtype=layoutMenu]'
        },
        {
            ref: 'CenterRegion',
            selector: '[xtype=layoutCenter]'
        },
        {
            ref: 'LoggedIn',
            selector: 'label#logged_in'
        }
    ],

    init: function() {
        this.listen({
            controller: {
                '#App': {
                    tokenchange: this.dispatch
                }
            },
            component: {
                'menu[xtype=layoutMenu] menuitem': {
                    click: this.addHistory
                },
                'grid[xtype=logs] textfield#search': {
                    change: { 
                      fn: this.onChangeSearchField,
                      scope: this,
                      buffer: 500
                    }  
                },                
                
            },
            global: {},
            store: {},
            proxy: {
                '#rest': {
                    requestcomplete: this.handleRESTResponse,
                    exeption: this.handleProxyExeption
                }
            }
        });
        var currentUser = Ext.decode( localStorage.getItem('currentUser'));
        coloMS.LoggedInUser = Ext.create( 'coloMS.model.security.User', eval("("+currentUser+")") );     
    },

    addHistory: function(item, e, opts) {
        var me = this,
            token = item.itemId;
        Ext.util.History.add( token );
        me.fireEvent( 'tokenchange', token );

    },

    dispatch: function(token) {
        var me = this,
            config;
        // switch on token to determine which content to create
        switch( token ) {
            case 'staff':
            config = {
                xtype: 'staff.list'
            };
            break;
            case 'options':
            config = {
                xtype: 'panel',
                title: 'Options',
                html: 'Some options content'
            };
            case 'options-roles':
            config = {
                xtype: 'options.List',
                title: 'Roles',
                iconCls: 'silk-user',
                store: Ext.create('coloMS.store.options.Roles',{
                    pageSize: 30
                })
            };            
            break;
            case 'inventory':
            config = {
                xtype: 'panel',
                title: 'Inventory',
                html: 'Some inventory content' 
            };
            break;
            case 'inventory-vendors':
            config = {
                xtype: 'inventoryList',
                title: 'Vendors',
                iconCls: 'silk-vcard',
                store: Ext.create('coloMS.store.inventory.Vendors',{
                    pageSize: 30
                })
            };
            break;    
            case 'inventory-product-types':
            config = {
                xtype: 'inventoryList',
                title: 'Product Types',
                iconCls: 'silk-tag',
                store: Ext.create('coloMS.store.inventory.ProductTypes',{
                    pageSize: 30
                })
            };        
            break;
            case 'inventory-models':
            config = {
                xtype: 'modelList',
                title: 'Models',
                store: Ext.create('coloMS.store.inventory.Models',{
                    pageSize: 30
                })
            };        
            break;
            case 'inventory-distributors':
            config = {
                xtype: 'distributorsList',
                title: 'Distributors',
                store: Ext.create('coloMS.store.inventory.Distributors',{
                    pageSize: 30
                })
            };        
            break;    
            case 'inventory-orders':
            config = {
                xtype: 'orderList',
                title: 'Orders',
                store: Ext.create('coloMS.store.inventory.Orders',{
                    pageSize: 30
                })
            };        
            break;                
            case 'inventory-items':
            config = {
                xtype: 'itemsMain',
                title: 'Items'
            };        
            break; 
            case 'inventory-equipments':
            config = {
                xtype: 'equipmentsMain',
                title: 'Equipments'
            };        
            break; 
                                                  
            default: 
            config = {
                xtype: 'layoutLanding'
            };
            break;
        }
        me.updateCenterRegion( config );
    },

    updateCenterRegion: function(config) {
        var me = this,
            center = me.getCenterRegion();

        // remove all existing content
        center.removeAll( true );
        // add new content
        center.add( config );

    },

    handleRESTResponse: function(request, success) {
        var me = this,
            rawData = request.proxy.reader.rawData;
        // in all cases, let's hide the body mask
        Ext.getBody().unmask();
        // if proxy success
        //console.log(request);
        if( success ) {
            // if operation success
            if( request.operation.wasSuccessful() ) {
                //...
                if ((request.action == 'create') || (request.action == 'update') || (request.action == 'destroy')) {
                    var grid = Ext.ComponentQuery.query('grid[xtype=logs]')[0];
                    var store = grid.getStore();
                    store.reload();
                }
            }
            // if operation failure
            else {
                // switch on operation failure type
                switch( rawData.type ) {
                    case 'validation':
                    me.showValidationMessage( rawData.data, rawData.success, rawData.message, rawData.type );
                    break;
                }
            }
        }
        // otherwise, major failure...
        else {
            // ...
        }

    },

    showValidationMessage: function(data, success, message, type) {
        var me = this,
            errorString = '<ul>';
        // looping over the errors
        for( var i in data ) {
            var error = data[ i ];
            errorString += '<li>' + '<b>' + error.field + '</b>: ' + error.message + '</li>';
            // match form field with same field name
            var fieldMatch = Ext.ComponentQuery.query( 'field[name=' + error.field + ']' );
            // match?
            if( fieldMatch.length ) {
                // add extra validaiton message to the offending field
                fieldMatch[ 0 ].markInvalid( error.message );
            }
        }
        errorString += '</ul>';
        // display error messages in modal alert
        Ext.MessageBox.show({
            title: message,
            msg: errorString,
            icon: Ext.MessageBox.ERROR,
            buttons: Ext.Msg.OK
        });
    },

    handleProxyExeption: function(proxy, response, operation, eOpts) {
        console.log(obj);
        var obj = Ext.decode(response.responseText);

        var srvErr = operation.getError();
        if(!srvErr) {
            var msg = obj.name[0];
        } else {
            msg = operation.getError().statusText;
        }    
        Ext.MessageBox.show({
            title: 'ERROR',
            msg: msg,
            icon: Ext.MessageBox.ERROR,
            buttons: Ext.Msg.OK
        });
    }

});